<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
    <title>node-note</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/reset.less" rel="stylesheet/less"/>
    <link href="/css/main.less" rel="stylesheet/less"/>
    <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
    <script src="/js/less.js" type="text/javascript" charset="utf-8"></script>
    <script src="/js/jquery-1.11.3.min.js"></script>
</head>
<body>

<div class="container note-info note-user note-telephone">
    <header class="clearfix header" >
        <a href="javascript:history.back(-1)" class="f_l">
            <i class="fa fa-chevron-left fa-lg"></i>
        </a>
        <%if (telephone) {%>
            <span class="header-text change-telephone">换绑手机</span>         
        <%} else{%>
            <span class="header-text bind-telephone">绑定手机<%=telephone%></span>
        <%}%>
    </header>
    <div class="content login-register">
        <div class="forms-item">
            <div class="form-item clearfix">
                <i class="fa fa-phone fa-lg label-icon"></i>
                <input type="tel" class="form-control" maxlength="11" id="telephone" placeholder="手机号">
                <button class="get-code" disabled="disabled">获取验证码</button>
            </div>
            <div class="form-item clearfix">
                <i class="fa fa-file-text-o fa-lg label-icon"></i>
                <input type="text" class="form-control" id="identifying-code" placeholder="验证码">
            </div>
        </div>
        <div class="prompt" role="alert">错误</div>
        <button type="button" class="btn btn-customized bind-telephone" id="submit">确定</button>
    </div>
</div>

<script type="text/javascript">
    function BindTelephone() {
        this.init();
    }
    BindTelephone.prototype={
        constructor: BindTelephone,
        init: function () {
            this.doSubmit();
            this.teleInput();
        },
        //登录
        doSubmit: function () {
            var _this=this;
            $('#submit').click(function () {
                var tele=_this.prompt('#telephone','请填写手机号');
                if (!tele) return;
                var code=_this.prompt('#identifying-code','请填写验证码');
                if (!code) return;
                // console.log('点击登录按钮');
                _this.submitMessage();
            })
        },
        //检测手机号输入框
        teleInput: function () {
            var _this=this;
            $('#telephone').bind('input',function () {
                if (_this.testTele()) {
                    $('.get-code').removeAttr('disabled').css({
                        color: '#34495e'
                    });
                    _this.teleCode();
                } else{
                    $('.get-code').attr('disabled','disabled').css({
                        color: '#ccc'
                    });
                }
            });           
        },  
        //正则匹配手机号
        testTele: function () {
            var tele=document.getElementById('telephone').value;
            var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;  
            if (!myreg.test(tele)) {  
                return false;  
            } else{  
                return true;  
            } 
        }, 
        //提示信息
        prompt: function (id,text) {
            var _this=this;
            if ($(id).val()=='') {
                /*$('.prompt').html(text).css({
                    'visibility': 'visible'
                });*/
                _this.promptDom(text);
                return false;
            }
            return true;
        }, 
        //DOM元素prompt设定
        promptDom: function (text,visible) {
            if (!visible){
                var visible='visible';
            } 
            $('.prompt').html(text).css({
                'visibility': visible
            });
        },
        //获取手机验证码
        teleCode: function () {
            // console.log('点击了几次');
            $('.get-code').click(function (event) {
                event.stopPropagation();
                $.post('/teleCode',{
                    'telephone': $('#telephone').val()
                },function (result) {
                    if (result!=='1') {
                        return; 
                    }
                })
                $('.get-code').attr('disabled','disabled').css({
                    color: '#ccc'
                });
                var timer=setTimeout(function () {
                    $('.get-code').removeAttr('disabled').css({
                        color: '#34495e'
                    });
                    clearTimeout(timer);
                },2000)
            })
        },
        //短信登录
        submitMessage: function () {
            var _this=this;
            $.post('/bindTelephone',{
                'telephone': $('#telephone').val(),
                'message': $('#identifying-code').val()
            },function (result) {
                if (result=='1') {
                    window.location='/noteUser';//绑定成功
                    // console.log('绑定成功');
                } else if(result=='-1'){
                    _this.promptDom('手机号已被注册');
                } else if(result=='-2'){
                    _this.promptDom('验证码不正确');
                }
            })
        },  
    }
    new BindTelephone();



        
    //更改手机号
    function ChangeTelephone() {
        this.init();
    }
    ChangeTelephone.prototype={
        constructor: ChangeTelephone,
        init: function () {
            this.submit();
        },
        submit: function () {
            var _this=this;
            $('#submit').click(function () {
                var user=_this.prompt('#telephone','手机号不能为空');
                if (!user) return;
                _this.toAjax();
            })
        },
        //提示信息
        prompt: function (id,text) {
            var _this=this;
            if ($(id).val()=='') {
                _this.promptDom(text);
                return false;
            }
            return true;
        }, 
        //DOM元素prompt设定
        promptDom: function (text,visible) {
            if (!visible){
                var visible='visible';
            } 
            $('.prompt').html(text).css({
                'visibility': visible
            });
        }, 
        //ajax提交后天
        toAjax: function () {
            var _this=this;
            var val=$('#telephone').val();
            if (val=='') {
                return;  
            }
            $.post('/noteChangeTelephone',{
                'telephone': val
            },function (result) {
                if (result=='1') {
                    window.location='/noteUser';                  
                } else if(result=='2'){
                    _this.promptDom('新手机号和老手机号相同');
                } else{
                    return;
                }
            })
        }
                 
    }
    // new ChangeTelephone();
</script>
</body>
</html>